---
title: Scheduling
layout: article
study_design: true
---

A schedule describes how tasks will be scheduled by the Bridge server. A task describes an activity and a start and end time when the user should be prompted to perform that activity. Tasks also have additional state (not started, in progress, completed, expired, deleted). A client application may use all this information to inform the user about their ongoing participation in the study (e.g. to show that a task is coming up in 2 hours, or that it has expired, or that it is currently in progress).

Schedules are generated by a schedule plan, which assigns a given schedule to a given participant. In the simplest case, every participant gets the same schedule (and thus the same task scheduling logic); in more complex cases, researchers may assign users to different groups for A/B testing, or pursue other assignment strategies. A single schedule can be associated with more than one activity, if these should be grouped together. One reason to have multiple activities in a schedule is to co-vary activities in an A/B test.

There are two mutually exclusive strategies for scheduling (creating a schedule with fields from both these strategies is not allowed):

**By cron expression:** A cron expression is a configuration string that describes times on a calendar, and allows for schedules such as "Mondays and Fridays at 8am" or "The first Thursday of every month at noon." The format of the cron expression is the seven field format as described in the [documentation for the Java Quartz Scheduler](http://www.quartz-scheduler.org/documentation/quartz-1.x/tutorials/crontrigger) (note that there are other formats that take up to eleven fields, this [online cron expression generator](http://www.cronmaker.com/) creates expressions in the right format). Although cron-based schedules are not super-useful for scheduling study tasks, if you need this kind of schedule, cron expressions are a tried and successful way of describing them.

For example, "Ask for this survey on Monday, Wednesday and Friday starting at 6am, and remove the request from the interface 6 hours later", would look like:

```json
{
   "scheduleType": "recurring",
   "cronTrigger": "0 0 6 ? * MON,WED,FRI *",
   "expires": "PT6H"
}
```

**By time intervals from the time of an event:** Alternatively, tasks can be scheduled periodically from a specific event (such as the completion of a prior activity, or the date and time that a user enrolled in a study. Tasks are implicitly scheduled against enrollment date if no other event is specified). This approach allows you to schedule tasks such as "wait 2 weeks after enrollment and then schedule a task every 3 days thereafter" or "assign a task one hour after taking a medication."

An interval of "P3D" and times of "07:00" and "15:00" mean: "starting with the date of enrollment, schedule this task every 3 days at 7am and 3pm."

```json
{
    "scheduleType": "recurring",
    "interval": "P3D",
    "times": ["07:00", "15:00"]
}
```

More complex dependencies may come in the future, the most important of which will be scheduling against the completion of tasks (such that one task will not be scheduled until another is completed).

## Available Task Events

The following events are currently available for scheduling (set them as the eventId of the schedule):

|Event|Event ID structure|Description|
|---|---|---|
|Enrollment|enrollment|The time that the user signs the consent to participate in researcher. This event is the default for a schedule if no other eventId is provided or found.|
|Activity finished|activity:&lt;GUID&gt;:finished|The time a scheduled activity is finished. This can be used to create recurring schedules where a task is issued N days after the same task was last performed.|
|2 weeks before enrollment|two\_weeks\_before_enrollment|Start schedule two weeks before enrollment. |
|2 months before enrollment|two\_months\_before_enrollment|Start schedule two months before enrollment. |

## Task scheduling logic

When scheduling a task, the scheduler does the following:

* The scheduler selects a starting date and time. This would be the enrollment date by default;
* If a delay has been specified, it is added to that timestamp;
* If a cron trigger is defined, it then finds the next valid time using the cron expression, from that timestamp;
* Otherwise, it creates a task on that day for each of the times specified in the schedule (times after the event). The scheduler then applies the interval to the last of these timestamps, and continues assigning on the next day.
* Once the start time for the task is determined, if the schedule has an expires duration, that is added to the start time to derive the end time of the task;
* If a startsOn or endsOn timestamp have been defined and the schedule's originating event is outside of this window, then that task is not created. Similarly, in a recurring schedule, tasks won't be created after the endsOn timestamp, if it exists.
* The scheduler continues this way until it has all tasks up to a final date and time stamp;

_You must set an expiration duration on repeating tasks._

## Examples

"one week after enrollment at 8am, expires after 24 hours"

```json
{ 
   "expires":"PT24H",
   "delay":"P1W",
   "scheduleType":"once",
   "activities":[{ 
       "label":"Take the tapping test",
       "task":{
           "identifier":"tapTest",
           "type":"TaskReference"
       },
       "activityType":"task",
       "type":"Activity"
   }],
   "times":["08:00"],
   "type":"Schedule"
}
```

"one month after enrollment and every month thereafter"

```json
{   
    "delay":"P1M",
    "interval":"P1M",
    "scheduleType":"recurring",
    "activities":[   
        {   
            "label":"Take the tapping test",
            "task":{   
                "identifier":"tapTest",
                "type":"TaskReference"
            },
            "activityType":"task",
            "type":"Activity"
        }
    ],
    "times":[   
        "08:00"
    ],
    "type":"Schedule"
}
```

"at enrollment and every week thereafter"

```json
{ 
    "interval":"P1W",
    "scheduleType":"recurring",
    "activities":[{ 
        "label":"Take the tapping test",
        "task":{
            "identifier":"tapTest",
            "type":"TaskReference"
        },
        "activityType":"task",
        "type":"Activity"
    }],
    "times":["06:00"],
    "type":"Schedule"
}
```

"Monday and Friday at 8am, but after four hours remove the task"

```json
{ 
    "cronTrigger":"0 0 8 ? * MON,WED *",
    "expires":"PT4H",
    "scheduleType":"recurring",
    "activities":[{ 
        "label":"Take the tapping test"
        "task":{
            "tapTest",
            "type":"TaskReference"
        },
        "activityType":"task",
        "type":"Activity"
    }],
    "type":"Schedule"
}
```

"an hour after taking medication, giving them an hour to complete the task"

```json
{ 
    "expires":"PT1H",
    "eventId":"completedOn:task:medication",
    "delay":"PT1H",
    "scheduleType":"once",
    "activities":[{ 
        "label":"Take the tapping test",
        "task":{
            "identifier":"tapTest",
            "type":"TaskReference",
        },
        "activityType":"task",
        "type":"Activity"
    }],
    "type":"Schedule"
}
```

"wait 3 days, and then every 7 days at 2pm"

```json
{ 
    "delay":"P3D",
    "interval":"P7D",
    "scheduleType":"recurring",
    "activities":[{ 
        "label":"Take the tapping test",
        "task":{
            "identifier":"tapTest",
            "type":"TaskReference"
        },
        "activityType":"task",
        "type":"Activity"
    }],
    "times":["14:00"],
    "type":"Schedule"
}
```

"wait 2 days, then every other day at 7am and 4pm, available for 4 hours each time" 

```json
{ 
    "expires":"PT4H",
    "delay":"P2D",
    "interval":"P2D",
    "scheduleType":"recurring",
    "activities":[{ 
        "label":"Take the tapping test",
        "task":{
            "identifier":"tapTest",
            "type":"TaskReference"
        },
        "activityType":"task",
        "type":"Activity"
    }],
    "times":["07:00","16:00"],
    "type":"Schedule"
}
```

"after enrollment every day until 2015-03-26"

```json
{ 
    "interval":"P1D",
    "scheduleType":"recurring",
    "activities":[{ 
        "label":"Take the tapping test",
        "task":{
            "identifier":"tapTest",
            "type":"TaskReference"
        },
        "activityType":"task",
        "type":"Activity"
    }],
    "endsOn":"2015-03-26T17:00:00.000Z",
    "times":["09:00"],
    "type":"Schedule"
}
```

"at the time of enrollment, then each time the task is finished, wait 7 days and then ask for it again"

```json
{   
    "scheduleType":"once",
    "eventId":"survey:248cff84-adbe-47a0-ae20-da86e8f6ef5c:finished,enrollment",
    "delay":"P7D",
    "activities":[   
        {   
            "label":"Take survey",
            "labelDetail":"28 Questions (7 minutes)",
            "survey":{   
                "identifier":"identifier",
                "guid":"GUID-AAA",
                "createdOn":"2015-01-27T17:46:31.237Z",
                "href":"http://localhost:9000/v3/surveys/GUID-AAA/revisions/2015-01-27T17:46:31.237Z",
                "type":"SurveyReference"
            },
            "activityType":"survey",
            "type":"Activity"
        }
    ],
    "times":["09:00"],
    "type":"Schedule"
} 
```
